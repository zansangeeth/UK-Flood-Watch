/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import r from"../PopupTemplate.js";import{ClonableMixin as t}from"../core/Clonable.js";import i from"../core/Collection.js";import o from"../core/Error.js";import has from"../core/has.js";import{MultiOriginJSONMixin as s}from"../core/MultiOriginJSONSupport.js";import{setDeepValue as p}from"../core/object.js";import{watch as n}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{reader as l}from"../core/accessorSupport/decorators/reader.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{writer as m}from"../core/accessorSupport/decorators/writer.js";import d from"../geometry/Extent.js";import y from"../geometry/SpatialReference.js";import c from"../graphic/ParquetGraphicOrigin.js";import f from"./Layer.js";import{ParquetSource as h}from"./graphics/sources/ParquetSource.js";import{BlendLayer as g}from"./mixins/BlendLayer.js";import{CustomParametersMixin as j}from"./mixins/CustomParametersMixin.js";import{DisplayFilteredLayer as v}from"./mixins/DisplayFilteredLayer.js";import{FeatureEffectLayer as w}from"./mixins/FeatureEffectLayer.js";import{FeatureReductionLayer as b}from"./mixins/FeatureReductionLayer.js";import{OperationalLayer as q}from"./mixins/OperationalLayer.js";import{OrderedLayer as x}from"./mixins/OrderedLayer.js";import{ScaleRangeLayer as O}from"./mixins/ScaleRangeLayer.js";import{TemporalLayer as I}from"./mixins/TemporalLayer.js";import{labelsVisible as F,legendEnabled as P,popupEnabled as T}from"./support/commonProperties.js";import L from"./support/FeatureTemplate.js";import R from"./support/Field.js";import{defineFieldProperties as S}from"./support/fieldProperties.js";import{fixRendererFields as E,fixTimeInfoFields as U}from"./support/fieldUtils.js";import _ from"./support/LabelClass.js";import{reader as D}from"./support/labelingInfo.js";import{ParquetEncodingBase as C}from"./support/ParquetEncodingBase.js";import Q from"./support/ParquetEncodingLocation.js";import z from"./support/ParquetEncodingWkb.js";import{parquetGeometryTypeKebabDict as k}from"./support/parquetUtils.js";import{rendererTypes as J}from"../renderers/support/typeUtils.js";import M from"../rest/support/Query.js";import{t as B}from"../chunks/persistableUrlUtils.js";import{createPopupTemplate as G}from"../support/popupUtils.js";const N=S(),V="__OBJECTID",W={types:{key:"type",base:C,typeMap:{wkb:z,location:Q}},json:{name:"layerDefinition.geometryEncoding",write:{ignoreOrigin:!0,isRequired:!0},origins:{service:{read:{source:"geometryEncoding"}}}}};let H=class extends(v(b(w(g(x(I(O(q(s(j(t(f)))))))))))){constructor(e){super(e),this.copyright=null,this.displayOptimization=null,this.fields=null,this.fieldsIndex=null,this.encoding=null,this.fullExtent=null,this.geometryType=null,this.graphicOrigin=new c(this),this.labelsVisible=!0,this.labelingInfo=null,this.objectIdField=V,this.operationalLayerType="ParquetLayer",this.outFields=null,this.persistenceEnabled=!!has("parquetlayer-persistence-enabled"),this.popupTemplate=null,this.source=null,this.spatialReference=null,this.templates=null,this.title="Parquet",this.type="parquet",this.urls=new i}destroy(){this.source?.destroy()}async load(e){return this.addResolvingPromise(this._load(e)),this.addHandles([n(()=>this.urls,e=>this.source?.updateFiles(e.items)),n(()=>this.customParameters,e=>this.source?.setCustomParameters(e))]),this}get capabilities(){return this.source?.capabilities}get defaultPopupTemplate(){return this.createPopupTemplate()}writeFields(e,r,t,i){const o=e.filter(e=>!(e.name===V&&"oid"===e.type)).map(e=>e.toJSON(i));p(t,o,r)}get isTable(){return null==this.encoding}set renderer(e){E(e,this.fieldsIndex),this._set("renderer",e)}readUrls(e){return new i("files"===e.type?e.urls:[])}writeUrls(e,r,t,i){const s=[];if(e?.length){i={blockedRelativeUrls:i?.blockedRelativeUrls};for(let r of e)r=B(r,i),r&&s.push(r)}s.length?r.source={type:"files",urls:s}:i.messages?.push(new o("parquet-layer:missing-urls","Missing or empty 'urls'",{layer:this}))}createPopupTemplate(e){return G(this,e)}createQuery(){const e=new M;return e.returnGeometry=!0,e.outFields=["*"],e}async createSource(e){const r=new h({layer:this});return await r.load(e),r}getFieldDomain(e,r){return null}getField(e){return this.fieldsIndex.get(e)}async queryFeatures(e,r){await this.load();const t=await this.source.queryFeatures(this._normalizeQuery(e),r),i=this.graphicOrigin;if(t?.features)for(const o of t.features)o.layer=o.sourceLayer=this,o.origin=i;return t}async queryObjectIds(e,r){return await this.load(),this.source.queryObjectIds(this._normalizeQuery(e),r)}async queryFeatureCount(e,r){return await this.load(),this.source.queryFeatureCount(this._normalizeQuery(e),r)}async queryExtent(e,r){return await this.load(),this.source.queryExtent(this._normalizeQuery(e),r)}_normalizeQuery(e){return M.from(e)??this.createQuery()}async _load(e){const r=await this.createSource(e);this._set("source",r),this.read(r.sourceJSON,{origin:"service"}),this.revert(["fields","timeInfo"],"service"),E(this.renderer,this.fieldsIndex),U(this.timeInfo,this.fieldsIndex),null==this.spatialReference&&(this.spatialReference=y.WGS84)}};e([a({readOnly:!0,json:{read:!1,write:!1}})],H.prototype,"capabilities",null),e([a({type:String})],H.prototype,"copyright",void 0),e([a({readOnly:!0})],H.prototype,"defaultPopupTemplate",null),e([a()],H.prototype,"displayOptimization",void 0),e([a({type:[R],json:{name:"layerDefinition.fields",write:{ignoreOrigin:!0,isRequired:!0},origins:{service:{name:"fields"}}}})],H.prototype,"fields",void 0),e([m("fields")],H.prototype,"writeFields",null),e([a(N.fieldsIndex)],H.prototype,"fieldsIndex",void 0),e([a(W)],H.prototype,"encoding",void 0),e([a({type:d,json:{name:"extent"}})],H.prototype,"fullExtent",void 0),e([a({type:k.apiValues,json:{name:"layerDefinition.geometryType",read:{reader:k.read},write:{writer:k.write,ignoreOrigin:!0,isRequired:!0},origins:{service:{read:{source:"geometryType",reader:k.read}}}}})],H.prototype,"geometryType",void 0),e([a({readOnly:!0,clonable:!1})],H.prototype,"graphicOrigin",void 0),e([a(F)],H.prototype,"labelsVisible",void 0),e([a({type:[_],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:{reader:D},write:!0}})],H.prototype,"labelingInfo",void 0),e([a(P)],H.prototype,"legendEnabled",void 0),e([a()],H.prototype,"file",void 0),e([a({type:String,readOnly:!0})],H.prototype,"objectIdField",void 0),e([a({type:["ParquetLayer"]})],H.prototype,"operationalLayerType",void 0),e([a(N.outFields)],H.prototype,"outFields",void 0),e([a(T)],H.prototype,"popupEnabled",void 0),e([a({type:r,json:{name:"popupInfo",write:!0}})],H.prototype,"popupTemplate",void 0),e([a({types:J,json:{name:"layerDefinition.drawingInfo.renderer",write:!0,origins:{service:{read:{source:"drawingInfo.renderer"}}}}})],H.prototype,"renderer",null),e([a({type:h,readOnly:!0,cast:null,json:{read:!1}})],H.prototype,"source",void 0),e([a({json:{name:"layerDefinition.spatialReference",write:{ignoreOrigin:!0,isRequired:!0},origins:{service:{read:{source:"extent.spatialReference"}}}}})],H.prototype,"spatialReference",void 0),e([a({type:[L]})],H.prototype,"templates",void 0),e([a()],H.prototype,"title",void 0),e([a({json:{read:!1},readOnly:!0})],H.prototype,"type",void 0),e([a({type:i.ofType(String),json:{name:"source",write:{isRequired:!0,ignoreOrigin:!0}}})],H.prototype,"urls",void 0),e([l("urls")],H.prototype,"readUrls",null),e([m("urls")],H.prototype,"writeUrls",null),H=e([u("esri.layers.ParquetLayer")],H);const A=H;export{A as default};
