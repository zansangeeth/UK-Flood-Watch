/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import{isSome as e,unique as r}from"../../core/arrayUtils.js";import s from"../../core/Error.js";import{abortHandle as o}from"../../core/handleUtils.js";import{getOrCreateMapValue as i}from"../../core/MapUtils.js";import{EsriPromise as a}from"../../core/Promise.js";import{throwIfAborted as l,isAbortError as n}from"../../core/promiseUtils.js";import u from"../../core/ReactiveMap.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{isSubtypeSublayer as d}from"../../layers/support/layerUtils.js";import c from"./Edits.js";import{fetchFullFeaturesByObjectId as m}from"./workflowUtils.js";let h=class extends a{constructor(t){super(t),this.editorItems=[],this.featureInfos=null,this.parent=null,this.selectedFeature=null,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null,this._editorItemsByLayer=new u,this._fullFeatures=new u,this._pendingEdits=new u}initialize(){const t=new AbortController;this.addResolvingPromise(this._initializeFullFeatures(t.signal).then(e=>{l(t.signal),this._initializeEdits(e)}).catch(t=>{if(n(t))throw new s("update-features-workflow:full-features-aborted","Fetching of full features was aborted.");throw t})),this.addHandles(o(t)),this._initializeEditorItemsByLayer()}get features(){return this.fullFeatures}get fullFeatures(){return Array.from(this._fullFeatures.values())}get initialFeatures(){return Array.from(this._pendingEdits.values()).map(t=>t.initialFeature).filter(e)}get layers(){const{featureInfos:t,features:s}=this;return t?.length?t.map(t=>t.layer):s.length?r(s.map(t=>t.sourceLayer).filter(e)):[]}set timeZone(t){this._set("timeZone",t),this._pendingEdits.forEach(e=>{e.timeZone=t})}getEditorItemForLayer(t){return this._editorItemsByLayer.get(t)}getFeatureTitle(t){return this._pendingEdits.get(t)?.displayTitle}getPendingEditsForFeature(t){const e=t.getObjectId();if(null!=e)return this._pendingEdits.get(this._fullFeatures.get(e)??t)}isSubmittable(t){const e=this._pendingEdits.get(t);return!!e&&(e.submittable||e.isAssociation)}stageDelete(){for(const t of this._pendingEdits.values())t.stageDelete()}_initializeEditorItemsByLayer(){for(const t of this.editorItems)this._editorItemsByLayer.set(t.layer,t)}_initializeEdits(t){const{timeZone:e}=this;for(const r of t){const t=new c({feature:r,timeZone:e});t.trackChanges(),this._pendingEdits.set(r,t)}}async _initializeFullFeatures(t){const{_fullFeatures:e,featureInfos:r,features:o,viewModel:a}=this,{spatialReference:l}=a.view,n=new Map;if(r?.length)for(const{layer:s,objectIds:i}of r)n.set(d(s)?s.parent:s,i);else if(o.length)for(const s of o){const t=s.getObjectId();if(null!=t){const e=s.sourceLayer??s.layer,r=d(e)?e.parent:e;i(n,r,()=>[]).push(t)}}const u=Array.from(n.entries()).map(async([r,o])=>{const i=await m(o,r,l,t);if(i.length!==o.length)throw new s("editor:update-features-workflow:fetch-full-features-incomplete","Failed to fetch full features for one or more of the provided features.");const a=r.objectIdField,n=(t,e)=>t.attributes[a]>e.attributes[a]?1:-1,u=o.sort((t,e)=>t-e),p=i.sort(n);for(let t=0;t<u.length;t++)e.set(u[t],p[t]);return i});return(await Promise.all(u)).flat()}};t([p({constructOnly:!0})],h.prototype,"editorItems",void 0),t([p({constructOnly:!0})],h.prototype,"featureInfos",void 0),t([p()],h.prototype,"features",null),t([p()],h.prototype,"fullFeatures",null),t([p()],h.prototype,"initialFeatures",null),t([p()],h.prototype,"layers",null),t([p()],h.prototype,"parent",void 0),t([p()],h.prototype,"selectedFeature",void 0),t([p({constructOnly:!0})],h.prototype,"sketchOptions",void 0),t([p()],h.prototype,"snappingManager",void 0),t([p()],h.prototype,"timeZone",null),t([p()],h.prototype,"viewModel",void 0),t([p()],h.prototype,"_fullFeatures",void 0),h=t([f("esri.widgets.Editor.UpdateFeaturesWorkflowData")],h);const y=h;export{y as default};
