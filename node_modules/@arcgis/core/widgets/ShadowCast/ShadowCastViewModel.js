/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import e from"../../Color.js";import i from"../../core/Accessor.js";import{isSome as r}from"../../core/arrayUtils.js";import{createTask as s}from"../../core/asyncUtils.js";import"../../core/has.js";import{abortMaybe as o,destroyMaybe as n}from"../../core/maybe.js";import{after as a,throwIfAborted as l}from"../../core/promiseUtils.js";import{watch as u,syncAndInitial as p}from"../../core/reactiveUtils.js";import{createScreenPointArray as d,createRenderScreenPointArray as h}from"../../core/screenUtils.js";import{convertTime as c,offsetDateUTC as m}from"../../core/timeUtils.js";import{property as f}from"../../core/accessorSupport/decorators/property.js";import"../../core/Logger.js";import{subclass as _}from"../../core/accessorSupport/decorators/subclass.js";import{create as g}from"../../core/libs/gl-matrix-2/factories/vec3f64.js";import{longitudeToTimezone as y}from"../../views/3d/support/earthUtils.js";import{computeDirectionsOverTime as v}from"../../views/3d/support/sunUtils.js";import w from"./DiscreteOptions.js";import D from"./DurationOptions.js";import{ShadowTooltipViewModel as T}from"./ShadowTooltipViewModel.js";import O from"./ThresholdOptions.js";import{breadthFirstBinaryPartitioning as P}from"../support/traversalUtils.js";const b=[],C=g(),z=[],U=255,V=c(1,"hours","milliseconds"),j=500;let x=class extends i{constructor(t){super(t),this.view=null,this.tooltip=new T({getDuration:t=>this.getDuration(t)}),this.startTimeOfDay=c(10,"hours","milliseconds"),this.endTimeOfDay=c(16,"hours","milliseconds"),this.visualizationType="threshold",this.thresholdOptions=new O,this.durationOptions=new D,this.discreteOptions=new w,this._running=!0,this._stopPreviewingTask=null,this._forcePreview=!1,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this.addHandles([u(()=>({view:this.view,tooltipEnabled:this._tooltipEnabled}),({view:t,tooltipEnabled:e})=>{this.tooltip.view=t,this.tooltip.enabled=e},p),u(()=>this._forcePreviewDependencies,()=>{o(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=s(async t=>{await a(j,t),l(t),this._forcePreview=!1}))},p),u(()=>({renderer:this.renderer,parameters:this._visualizationParameters}),t=>E(t.renderer,t.parameters),p),u(()=>({renderer:this.renderer,lightDirections:this._lightDirections,lightDirectionsContext:this._lightDirectionsContext}),t=>E(t.renderer,{lightDirections:t.lightDirections,lightDirectionsContext:t.lightDirectionsContext}),p),u(()=>({renderer:this.renderer,parameters:{enabled:this._running}}),t=>E(t.renderer,t.parameters),p),u(()=>({renderer:this.renderer,parameters:{previewing:this._previewing}}),t=>E(t.renderer,t.parameters),p)])}destroy(){this.stop(),E(this.renderer,{enabled:!1}),n(this.tooltip)}get state(){return null!=this.view&&this.view.ready&&null!=this._referencePosition?"ready":"disabled"}set date(t){const e=new Date(t);e.setHours(0,0,0,0),this._set("date",e)}get utcOffset(){return this._utcOffset??this._utcOffsetAuto}set utcOffset(t){this._utcOffset=t}get testData(){}get _previewing(){const{view:t}=this;if(null==t?.allLayerViews)return!0;const{stationary:e,allLayerViews:i,graphicsView:r}=t;return this._forcePreview||!e||i.some(t=>S(t)&&t.updating)||!r?.suspended&&!!r?.updating}get _utcOffsetAuto(){const t=this._referencePosition;return null!=t?y(t[0],!1):0}get _dateUTCOffset(){let t=this.date;return t=m(t,-t.getTimezoneOffset(),"minutes"),t=m(t,-this.utcOffset,"hours"),t}get _startDateTimeUTC(){return m(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return m(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return this.view?.environmentManager?.referencePositionGeographic}get _durationInterval(){return this._duration>0?Math.floor(this._duration/(U-1)):U}get _interval(){const t=this._durationInterval;switch(this.visualizationType){case"threshold":case"duration":return t;case"discrete":return this.discreteOptions.interval||t}}get _intervalContext(){const{contextEnabled:t,contextOptions:{interval:e}}=this.thresholdOptions;return"threshold"===this.visualizationType&&t?e||this._durationInterval:-1}get _durationSampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){return this._calculateLightDirections(this._interval)}get _lightDirectionsContext(){return this._calculateLightDirections(this._intervalContext)}_calculateLightDirections(t){const{view:e}=this;if(null==e||t<=0)return b;const i="global"===e.viewingMode?C:this._referencePosition;if(null==i)return b;const r=v(this._startDateTimeUTC,this._endDateTimeUTC,t,i,e.state.viewingMode,U),s=r.length;z.length=0;const o=P(0,s,z),n=new Array(s);for(let a=0;a<s;++a)n[a]=r[o[a]];return n}get _tooltipEnabled(){return"ready"===this.state&&"discrete"!==this.visualizationType&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case"threshold":return this._thresholdVisualizationParameters;case"duration":return this._durationVisualizationParameters;case"discrete":return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){const{value:t,color:i}=this.thresholdOptions,r=this._duration;return{visualization:2,thresholdColor:e.toUnitRGBA(i),threshold:r>0?t/this._duration:0,...this._thresholdDiscreteVisualizationParameters}}get _thresholdDiscreteVisualizationParameters(){const{contextOptions:{color:t},contextEnabled:i}=this.thresholdOptions;return i?{visualization:3,gradientColor:e.toUnitRGBA(t)}:{}}get _durationVisualizationParameters(){const{color:t,mode:i}=this.durationOptions,r=this._duration,s=r>0&&"hourly"===i?V/r:0,o=e.toUnitRGBA(t);return 0===s?{...this._discreteVisualizationParameters,gradientColor:o}:{bandedGradientColor:o,visualization:1,bandSize:s}}get _discreteVisualizationParameters(){return{gradientColor:e.toUnitRGBA(this.discreteOptions.color),visualization:0}}get _forcePreviewDependencies(){const{view:t}=this;if(null==t)return null;const e=t.slice.plane,i=t.allLayerViews.toArray().filter(S),s=i.map(t=>t.layer).filter(r),o=i.map(t=>t.suspended),n=s.map(t=>t.visible),a=s.map(t=>t.opacity),l=!!t.graphicsView?.suspended,u=s.filter(t=>"definitionExpression"in t).map(t=>t.definitionExpression),p=i.filter(t=>"filter"in t).map(t=>t.filter);return{slicePlane:e,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewSuspended:o,graphicsViewSuspended:l,layerVisibilities:n,layerOpacities:a,filters:p,definitionExpressions:u}}get renderer(){const{view:t}=this;if(null==t)return null;const e=t.stage;return null==e?null:e.renderer}start(){this.setRunning(!0)}stop(){this.setRunning(!1)}setRunning(t){this._running=t}async getDuration(t){const{view:e,renderer:i,_durationSampleCount:r}=this;if(null==e||null==i||0===r)return 0;const s=e.state.camera.screenToRender(d(t.x,t.y),h());return i.readAccumulatedShadow(s)*this._duration}};function E(t,e){null!=t&&null!=e&&t.setParameters({shadowCast:e})}function S(t){if(t.suspended)return!1;switch(t.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"integrated-mesh-3dtiles":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":case"catalog-footprint-3d":return!0;default:return!1}}t([f()],x.prototype,"state",null),t([f()],x.prototype,"view",void 0),t([f()],x.prototype,"tooltip",void 0),t([f({type:Date,nonNullable:!0})],x.prototype,"date",null),t([f({type:Number,nonNullable:!0})],x.prototype,"utcOffset",null),t([f({type:Number,nonNullable:!0})],x.prototype,"startTimeOfDay",void 0),t([f({type:Number,nonNullable:!0})],x.prototype,"endTimeOfDay",void 0),t([f({type:["threshold","duration","discrete"],nonNullable:!0})],x.prototype,"visualizationType",void 0),t([f({type:O,nonNullable:!0})],x.prototype,"thresholdOptions",void 0),t([f({type:D,nonNullable:!0})],x.prototype,"durationOptions",void 0),t([f({type:w,nonNullable:!0})],x.prototype,"discreteOptions",void 0),t([f()],x.prototype,"_running",void 0),t([f()],x.prototype,"_stopPreviewingTask",void 0),t([f()],x.prototype,"_forcePreview",void 0),t([f()],x.prototype,"_autoRestoreForcePreviewEnabled",void 0),t([f()],x.prototype,"_previewing",null),t([f()],x.prototype,"_utcOffset",void 0),t([f()],x.prototype,"_utcOffsetAuto",null),t([f()],x.prototype,"_dateUTCOffset",null),t([f()],x.prototype,"_startDateTimeUTC",null),t([f()],x.prototype,"_endDateTimeUTC",null),t([f()],x.prototype,"_referencePosition",null),t([f()],x.prototype,"_interval",null),t([f()],x.prototype,"_intervalContext",null),t([f()],x.prototype,"_durationSampleCount",null),t([f()],x.prototype,"_duration",null),t([f()],x.prototype,"_lightDirections",null),t([f()],x.prototype,"_lightDirectionsContext",null),t([f()],x.prototype,"_tooltipEnabled",null),t([f()],x.prototype,"_visualizationParameters",null),t([f()],x.prototype,"_thresholdVisualizationParameters",null),t([f()],x.prototype,"_thresholdDiscreteVisualizationParameters",null),t([f()],x.prototype,"_durationVisualizationParameters",null),t([f()],x.prototype,"_discreteVisualizationParameters",null),t([f()],x.prototype,"_forcePreviewDependencies",null),t([f()],x.prototype,"renderer",null),x=t([_("esri.widgets.ShadowCast.ShadowCastViewModel")],x);const A=x;export{A as default};
