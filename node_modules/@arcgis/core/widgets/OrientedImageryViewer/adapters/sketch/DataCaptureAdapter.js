/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import t from"../../../../core/Accessor.js";import r from"../../../../core/Collection.js";import o from"../../../../core/ReactiveMap.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{mapSpaceToImageSpace as s}from"../../dataCaptureUtils.js";import{SketchHandlerMixin as c}from"../../mixins/SketchHandlerMixin.js";let p=class extends(c(t)){constructor(e){super(e),this.savedGraphics=new r,this.type="data-capture",this.pendingGraphics=new o}get collectionId(){return this.viewModel.collectionId}handleCreate(e){const{state:t,graphic:r,tool:o}=e,i=r?.geometry;if("complete"!==t||!r||!i)return;const{collectionId:a,viewModel:{dataCaptureLayer:s,currentBestFeature:c,imageGeometryField:p,oiObjectIdField:n,activeViewer:l,mode:h},pendingGraphics:u}=this,m=l?.imageSize;c&&p&&a&&n&&s&&m&&"none"!==h&&"video"!==h&&"panoramic-video"!==h&&(d(r,i,p,n,c,u,a,m,h,s),this.viewModel.emit("after-data-capture-complete",{pendingGraphics:u.get(a)?.toArray()??null}),this.viewModel.sketch?.create(o))}handleDelete(e){const{dataCaptureLayer:t}=this.viewModel;if(!t)return;const{graphics:r}=e;this.pendingGraphics.get(t.id)?.removeMany(r),this.savedGraphics.removeMany(r),this.viewModel.deleteDataCaptureFeatures(n(r,t.objectIdField))}handleDestroy(){const{dataCaptureLayer:e}=this.viewModel;e&&(this.viewModel.stopDataCapture(),this.savedGraphics.removeAll(),this.pendingGraphics=null)}handleUpdate(e){const{toolEventInfo:t,state:r,graphics:o}=e;if(t)this.viewModel.sketch?.undo();else switch(r){case"complete":this.viewModel.emit("deselect-data-capture-features",{graphics:o});break;case"start":this.viewModel.emit("select-data-capture-features",{graphics:o})}}};function d(e,t,o,i,a,c,p,d,n,l){e.sourceLayer=l,e.attributes=e.attributes??{},e.attributes[o]=btoa(JSON.stringify({geometry:s(t.clone(),n,d).toJSON()})),e.attributes[i]=a.attributes.objectId,c.has(p)||c.set(p,new r);c.get(p).add(e)}function n(e,t){return e.map(({attributes:e})=>t?e[t]:null).filter(Boolean)}e([i()],p.prototype,"collectionId",null),e([i()],p.prototype,"savedGraphics",void 0),e([i()],p.prototype,"type",void 0),e([i()],p.prototype,"pendingGraphics",void 0),p=e([a("esri.widgets.OrientedImageryViewer.adapters.sketch.DataCaptureAdapter")],p);const l=p;export{l as default};
