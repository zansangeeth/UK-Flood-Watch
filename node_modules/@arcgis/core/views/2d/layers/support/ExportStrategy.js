/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import e from"../../../../core/Accessor.js";import"../../../../core/has.js";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from"../../../../core/promiseUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as p}from"../../../../core/accessorSupport/decorators/subclass.js";import{toExtent as n,create as m}from"../../../../geometry/support/aaBoundingRect.js";import{getInfo as d}from"../../../../geometry/support/spatialReferenceUtils.js";import h from"../../../../layers/support/TileInfo.js";import{getOuterSize as l,getBBox as c}from"../../viewStateUtils.js";import{Bitmap as u}from"../../engine/Bitmap.js";import g from"../../tiling/TileInfoView.js";import f from"../../tiling/TileKey.js";const y=m(),x=[0,0],S=new f(0,0,0,0),w={imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let M=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=w.hidpi,this.imageMaxWidth=w.imageMaxWidth,this.imageMaxHeight=w.imageMaxHeight,this.imageRotationSupported=w.imageRotationSupported,this.imageNormalizationSupported=w.imageNormalizationSupported,this.update=i(async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=d(i.spatialReference),a=this.hidpi?t.pixelRatio:1,p=i.worldScreenWidth>0,n=p&&this.imageNormalizationSupported&&i.worldScreenWidth<i.size[0],m=Math.round((this.imageMaxWidth??0)/a),h=Math.round((this.imageMaxHeight??0)/a);n?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):l(x,i);const c=Math.floor(x[0])>m||Math.floor(x[1])>h,u=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),g=!this.imageNormalizationSupported&&u,f=!c&&!g,y=this.imageRotationSupported?i.rotation:0,S=this.container.children.slice();if(f){const t=n?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,x,t,i.resolution,y,a,e)}else{let t=Math.min(m,h);p&&(t=Math.min(i.worldScreenWidth,t),t=Math.round(i.worldScreenWidth/Math.ceil(i.worldScreenWidth/t))),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of S)t.includes(e)||i.push(e.fadeOut().then(()=>{e.remove(),e.destroy()}));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(w){this._imagePromise=null,r(w)}},5e3),this.updateExports=i(async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then(()=>{i.invalidateTexture(),i.requestRender()}))}this._imagePromise=s(e).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(t=>t.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const p=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const n=new u(null,!0);return n.x=t.xmin,n.y=t.ymax,n.resolution=t.width/e,n.rotation=r,n.pixelRatio=s,n.opacity=0,this.container.addChild(n),await n.setSourceAsync(p,a),o(a),n}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const p=n(y,t.spatialReference);return[await this._export(p,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=h.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const p=[];return a.forEach((r,a,m,d)=>{S.set(r,a,m,0),s.getTileBounds(y,S);const h=n(y,t.spatialReference);p.push(this._export(h,e,e,0,i,o).then(t=>(0!==d&&(S.set(r,a,m,d),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t)))}),Promise.all(p)}};t([a()],M.prototype,"_imagePromise",void 0),t([a()],M.prototype,"bitmaps",void 0),t([a()],M.prototype,"container",void 0),t([a()],M.prototype,"fetchSource",void 0),t([a()],M.prototype,"hidpi",void 0),t([a()],M.prototype,"imageMaxWidth",void 0),t([a()],M.prototype,"imageMaxHeight",void 0),t([a()],M.prototype,"imageRotationSupported",void 0),t([a()],M.prototype,"imageNormalizationSupported",void 0),t([a()],M.prototype,"requestUpdate",void 0),t([a()],M.prototype,"updating",null),M=t([p("esri.views.2d.layers.support.ExportStrategy")],M);export{M as default};
