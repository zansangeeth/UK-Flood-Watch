/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../../../core/Error.js";import t from"../../../../geometry/Mesh.js";import{projectBuffer as r}from"../../../../geometry/projection/projectBuffer.js";import{toExtent as o}from"../../../../geometry/support/aaBoundingBox.js";import n from"../../../../geometry/support/MeshGeoreferencedVertexSpace.js";import{MeshVertexAttributes as a}from"../../../../geometry/support/MeshVertexAttributes.js";import{b as s,a as i}from"../../../../chunks/vec3.js";import{Metadata as c}from"../../../../geometry/support/meshUtils/Metadata.js";function l(e){const r=new c,o=e.spatialReference??e.layerView.view.spatialReference;return r.externalSources.add({extent:e.extent??m(e,o),source:{type:"loadable",load:t=>p(t,e)}}),new t({metadata:r,vertexSpace:new n,spatialReference:o})}function m({layerView:e,nodeIndex:t,featureIndex:n},a){const s=e.getAABB(t,n);if(!s)return null;const i=e.view.spatialReference;return i.equals(a)||r(s,i,0,s,a,0),o(s,a)}async function p(t,{layerView:o,nodeIndex:n,featureIndex:c}){const l=o.getNodeComponentHandle(n);if(!l?.intersectionGeometry)throw new e("i3s-layer-view-geometry-missing","Cannot load mesh because scene layer view data is no longer available.");const m={indices:null,data:null,stride:0,startIndex:0,endIndex:0};l.intersectionGeometry.getComponentPositions(c,m);const{indices:p,data:d,stride:f,startIndex:u,endIndex:x}=m,y=new Float64Array(3*(x-u));let w=0;for(let e=u;e<x;e+=3){const t=f*p[e],r=f*p[e+1],o=f*p[e+2];y[w++]=d[t],y[w++]=d[t+1],y[w++]=d[t+2],y[w++]=d[r],y[w++]=d[r+1],y[w++]=d[r+2],y[w++]=d[o],y[w++]=d[o+1],y[w++]=d[o+2]}const g=l.transform;s(y,y,g.rotationScale),i(y,y,g.position),r(y,o.view.renderSpatialReference,0,y,t.spatialReference,0),t.vertexAttributes=new a({position:y})}export{l as createMesh};
